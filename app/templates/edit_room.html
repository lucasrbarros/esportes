{% extends 'layout.html' %}

{% block title %}Editar {{ room.name }} - Esporte+{% endblock %}

{% block content %}
<div class="content-visible">
    <div class="row">
        <div class="col-lg-8 offset-lg-2">
            <div class="card edit-room-card" data-aos="fade-up" data-aos-duration="400">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0"><i class="bi bi-pencil-square me-2"></i>Editar Sala</h4>
                </div>
                <div class="card-body">
                    <form method="post" action="{{ url_for('room.edit_room', link_code=room.link_code) }}" class="edit-room-form">
                        {{ form.csrf_token }}
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <div class="form-group">
                                    <label for="{{ form.name.id }}" class="form-label">
                                        <i class="bi bi-tag me-2"></i>{{ form.name.label.text }}
                                    </label>
                                    {{ form.name(class="form-control form-control-lg", placeholder="Ex: Futebol de Quarta") }}
                                    <div class="form-text">Escolha um nome descritivo para sua sala</div>
                                    {% if form.name.errors %}
                                        <div class="text-danger">
                                            {% for error in form.name.errors %}
                                                <small><i class="bi bi-exclamation-circle me-1"></i>{{ error }}</small>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <div class="form-group">
                                    <label for="{{ form.sport.id }}" class="form-label">
                                        <i class="bi bi-trophy me-2"></i>{{ form.sport.label.text }}
                                    </label>
                                    <select class="form-control form-control-lg" id="{{ form.sport.id }}" name="sport">
                                        <option value="Futebol" {% if room.sport == 'Futebol' %}selected{% endif %}>Futebol</option>
                                        <option value="Vôlei" {% if room.sport == 'Vôlei' %}selected{% endif %}>Vôlei</option>
                                        <option value="Basquete" {% if room.sport == 'Basquete' %}selected{% endif %}>Basquete</option>
                                        <option value="Tênis" {% if room.sport == 'Tênis' %}selected{% endif %}>Tênis</option>
                                        <option value="Outros" {% if room.sport == 'Outros' %}selected{% endif %}>Outros</option>
                                    </select>
                                    <div class="form-text">Tipo de esporte que será praticado</div>
                                    {% if form.sport.errors %}
                                        <div class="text-danger">
                                            {% for error in form.sport.errors %}
                                                <small><i class="bi bi-exclamation-circle me-1"></i>{{ error }}</small>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <div class="form-group">
                                    <label for="{{ form.date.id }}" class="form-label">
                                        <i class="bi bi-calendar-event me-2"></i>{{ form.date.label.text }}
                                    </label>
                                    <div class="input-group">
                                        {{ form.date(class="form-control form-control-lg", type="datetime-local") }}
                                        <span class="input-group-text"><i class="bi bi-clock"></i></span>
                                    </div>
                                    <div class="form-text">Quando o evento irá acontecer</div>
                                    {% if form.date.errors %}
                                        <div class="text-danger">
                                            {% for error in form.date.errors %}
                                                <small><i class="bi bi-exclamation-circle me-1"></i>{{ error }}</small>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <div class="form-group">
                                    <label for="{{ form.max_participants.id }}" class="form-label">
                                        <i class="bi bi-people me-2"></i>{{ form.max_participants.label.text }}
                                    </label>
                                    <div class="input-group">
                                        {{ form.max_participants(class="form-control form-control-lg", type="number", min=2) }}
                                        <span class="input-group-text"><i class="bi bi-person-plus"></i></span>
                                    </div>
                                    <div class="form-text">Quantas pessoas podem participar</div>
                                    {% if form.max_participants.errors %}
                                        <div class="text-danger">
                                            {% for error in form.max_participants.errors %}
                                                <small><i class="bi bi-exclamation-circle me-1"></i>{{ error }}</small>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <div class="form-group">
                                    <label for="court_id" class="form-label">
                                        <i class="bi bi-geo-alt me-2"></i>Quadra
                                    </label>
                                    <select class="form-control form-control-lg" id="court_id" name="court_id">
                                        <option value="">Sem quadra específica</option>
                                        <!-- As opções de quadras serão carregadas via JavaScript -->
                                    </select>
                                    <div class="form-text">Selecione uma quadra para usar suas informações de localização</div>
                                </div>
                            </div>
                        </div>
                        
                        <div id="courtInfoContainer" style="display: none;">
                            <div class="card mb-3 bg-light">
                                <div class="card-body">
                                    <h6 class="card-title" id="courtInfoName">-</h6>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <p class="mb-1 small"><i class="bi bi-geo-alt me-1"></i> <span id="courtInfoLocation">-</span></p>
                                            <p class="mb-1 small"><i class="bi bi-people me-1"></i> <span id="courtInfoCapacity">-</span> pessoas</p>
                                        </div>
                                        <div class="col-md-6">
                                            <p class="mb-1 small"><i class="bi bi-cash-coin me-1"></i> <span id="courtInfoPrice">-</span>/hora</p>
                                            <p class="mb-2 fw-bold small">Total: R$ <span id="courtInfoTotal">0.00</span></p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <div class="form-group">
                                <label for="{{ form.description.id }}" class="form-label">
                                    <i class="bi bi-card-text me-2"></i>{{ form.description.label.text }}
                                </label>
                                {{ form.description(class="form-control", rows=4, placeholder="Adicione informações importantes como regras, o que levar, etc.") }}
                                <div class="form-text">Informações adicionais sobre o evento (opcional)</div>
                                {% if form.description.errors %}
                                    <div class="text-danger">
                                        {% for error in form.description.errors %}
                                            <small><i class="bi bi-exclamation-circle me-1"></i>{{ error }}</small>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="mb-4 privacy-option">
                            <div class="card privacy-card">
                                <div class="card-body">
                                    <div class="form-check form-switch">
                                        {{ form.is_private(class="form-check-input") }}
                                        <label class="form-check-label" for="{{ form.is_private.id }}">
                                            <i class="bi bi-lock me-2"></i>{{ form.is_private.label.text }}
                                        </label>
                                    </div>
                                    <div class="privacy-info mt-2">
                                        <p class="mb-0">
                                            <i class="bi bi-info-circle me-1"></i>
                                            <small>Salas privadas só podem ser acessadas por pessoas com o link direto.</small>
                                        </p>
                                        <p class="mb-0">
                                            <i class="bi bi-globe me-1"></i>
                                            <small>Salas públicas aparecem para todos na página inicial.</small>
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary btn-lg save-btn">
                                <i class="bi bi-check-circle me-2"></i>Salvar Alterações
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            
            <div class="text-center mt-3 mb-5">
                <a href="{{ url_for('room.manage_room', link_code=room.link_code) }}" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left me-2"></i>Voltar para gerenciamento
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Definir a data mínima como hoje
        const dateInput = document.getElementById('{{ form.date.id }}');
        if (dateInput) {
            const now = new Date();
            const year = now.getFullYear();
            const month = (now.getMonth() + 1).toString().padStart(2, '0');
            const day = now.getDate().toString().padStart(2, '0');
            const hours = now.getHours().toString().padStart(2, '0');
            const minutes = now.getMinutes().toString().padStart(2, '0');
            
            const today = `${year}-${month}-${day}T${hours}:${minutes}`;
            dateInput.min = today;
        }
        
        // Carrregar quadras disponíveis
        loadCourts();
        
        // Event listeners para a quadra e duração
        const courtSelect = document.getElementById('court_id');
        
        if (courtSelect && dateInput) {
            courtSelect.addEventListener('change', updateCourtInfo);
            dateInput.addEventListener('change', function() {
                if (courtSelect.value) {
                    updateCourtInfo();
                }
            });
        }
        
        // Carregar quadras disponíveis via API
        function loadCourts() {
            fetch('/admin/api/courts')
                .then(response => response.json())
                .then(courts => {
                    const courtSelect = document.getElementById('court_id');
                    
                    // Obter ID da quadra atual, se houver
                    const currentCourtId = {% if room.court_id %}{{ room.court_id }}{% else %}null{% endif %};
                    
                    // Filtrar apenas quadras ativas
                    const activeCourts = courts.filter(court => court.is_active || court.id === currentCourtId);
                    
                    if (activeCourts.length === 0) {
                        return;
                    }
                    
                    // Adicionar cada quadra como uma opção
                    activeCourts.forEach(court => {
                        const option = document.createElement('option');
                        option.value = court.id;
                        option.textContent = `${court.name} - ${court.sport_type} (R$ ${court.hourly_price.toFixed(2)}/h)`;
                        option.dataset.price = court.hourly_price;
                        option.dataset.capacity = court.capacity;
                        option.dataset.location = court.location || '';
                        option.dataset.city = court.city || '';
                        
                        // Selecionar a quadra atual se estiver editando
                        if (court.id === currentCourtId) {
                            option.selected = true;
                        }
                        
                        courtSelect.appendChild(option);
                    });
                    
                    // Se houver uma quadra selecionada, atualizar as informações
                    if (currentCourtId) {
                        updateCourtInfo();
                    }
                })
                .catch(error => console.error('Erro ao carregar quadras:', error));
        }
        
        // Atualizar informações da quadra quando selecionada
        function updateCourtInfo() {
            const courtSelect = document.getElementById('court_id');
            const courtInfoContainer = document.getElementById('courtInfoContainer');
            const maxParticipantsInput = document.getElementById('{{ form.max_participants.id }}');
            
            if (!courtSelect.value) {
                courtInfoContainer.style.display = 'none';
                return;
            }
            
            // Obter informações da quadra selecionada
            const selectedOption = courtSelect.options[courtSelect.selectedIndex];
            const price = parseFloat(selectedOption.dataset.price);
            const capacity = parseInt(selectedOption.dataset.capacity);
            const location = selectedOption.dataset.location;
            const city = selectedOption.dataset.city;
            
            // Calcular duração com base na data selecionada (padrão: 1 hora)
            let duration = 1.0;
            
            // Atualizar informações no card
            document.getElementById('courtInfoName').textContent = selectedOption.textContent.split(' (')[0];
            document.getElementById('courtInfoLocation').textContent = location ? (city + ', ' + location) : city;
            document.getElementById('courtInfoCapacity').textContent = capacity;
            document.getElementById('courtInfoPrice').textContent = `R$ ${price.toFixed(2)}`;
            
            // Calcular valor total
            const totalValue = price * duration;
            document.getElementById('courtInfoTotal').textContent = totalValue.toFixed(2);
            
            // Adicionar campos ocultos para cidade e localização
            let cityInput = document.querySelector('input[name="city"]');
            let locationInput = document.querySelector('input[name="location"]');
            
            if (!cityInput) {
                cityInput = document.createElement('input');
                cityInput.type = 'hidden';
                cityInput.name = 'city';
                document.querySelector('form').appendChild(cityInput);
            }
            
            if (!locationInput) {
                locationInput = document.createElement('input');
                locationInput.type = 'hidden';
                locationInput.name = 'location';
                document.querySelector('form').appendChild(locationInput);
            }
            
            cityInput.value = city;
            locationInput.value = location;
            
            // Exibir o container de informações
            courtInfoContainer.style.display = 'block';
        }
    });
</script>
<style>
    .edit-room-card {
        border: none;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
        margin-bottom: 30px;
        margin-top: 20px;
    }
    
    .edit-room-card .card-header {
        padding: 20px 25px;
    }
    
    .edit-room-card .card-body {
        padding: 30px;
    }
    
    .edit-room-form .form-label {
        font-weight: 600;
        margin-bottom: 8px;
        color: var(--primary);
    }
    
    .edit-room-form .form-text {
        color: var(--gray);
        margin-top: 5px;
        font-size: 0.85rem;
    }
    
    .edit-room-form .form-control {
        padding: 12px 15px;
        border-color: var(--gray-light);
        transition: all 0.3s ease;
    }
    
    .edit-room-form .form-control:focus {
        border-color: var(--secondary);
        box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.25);
    }
    
    .privacy-card {
        background-color: #f8f9fa;
        border-left: 4px solid var(--primary);
    }
    
    .content-visible {
        opacity: 1 !important;
        transform: none !important;
        visibility: visible !important;
    }
    
    /* Estilos para o autocompletar de cidades */
    .city-input-container {
        position: relative;
    }
    
    .position-relative {
        position: relative !important;
    }
    
    .city-autocomplete {
        position: absolute;
        z-index: 1050;
        background: white;
        width: 100%;
        max-height: 300px;
        overflow-y: auto;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        border-radius: 0 0 8px 8px;
        top: 100%;
        left: 0;
        display: none;
        border: 1px solid #dee2e6;
        margin-top: 2px;
    }
    
    .city-suggestion {
        padding: 10px 15px;
        cursor: pointer;
        border-bottom: 1px solid #f0f0f0;
        transition: background-color 0.2s;
        white-space: normal;
        word-break: break-word;
        line-height: 1.4;
    }
    
    .city-suggestion:hover {
        background-color: #f8f9fa;
    }
    
    /* Melhorar posicionamento no desktop */
    @media (min-width: 992px) {
        .city-autocomplete {
            max-width: 100%;
            position: absolute;
        }
    }
</style>
{% endblock %} 